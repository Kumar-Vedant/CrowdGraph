// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String                   @id @default(uuid())
  username       String                   @unique
  passwordHash   String
  reputation     Int        @default(0)
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  // relations
  communities         UserCommunity[]
  ownedCommunities    Community[]   @relation("UserOwnedCommunities")
  posts               Post[]
  comments            Comment[]
  nodeProposals       NodeProposal[]
  edgeProposals       EdgeProposal[]
  votes               Vote[]
}

model Community {
  id                    String         @id @default(uuid())
  title                 String
  description           String?
  ownerId               String
  createdAt             DateTime       @default(now())
  totalVotingPotential  Int            @default(0)

  // relations
  owner                 User                     @relation("UserOwnedCommunities", fields: [ownerId], references: [id], onDelete: Cascade)
  members               UserCommunity[]
  posts                 Post[]
  nodeProposals         NodeProposal[]
  edgeProposals         EdgeProposal[]
}

model UserCommunity {

  userId      String
  communityId String
  role        Role
  reputation  Int        @default(30)
  credits     Int        @default(30)
  joinedAt    DateTime   @default(now())

  // relations
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  community   Community  @relation(fields: [communityId], references: [id], onDelete: Cascade)

  // composite PK
  @@id([userId, communityId])
}

model Post {
  id          String     @id @default(uuid())
  title       String
  content     String
  authorId    String
  communityId String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  voteCount   Int        @default(0)

  // relations
  author      User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  community   Community  @relation(fields: [communityId], references: [id], onDelete: Cascade)
  comments    Comment[]
}

model Comment {
  id             String     @id @default(uuid())
  postId         String
  userId         String
  content        String
  createdAt      DateTime   @default(now())
  parentCommentId String?
  voteCount   Int        @default(0)

  // relations
  post           Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentComment  Comment?   @relation("CommentHierarchy", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies        Comment[]  @relation("CommentHierarchy")
}

model NodeProposal {
  id            String           @id @default(uuid())
  userId        String
  communityId   String
  name          String
  labels        String[]
  properties    Json?
  proposalType  ProposalType     @default(CREATE)
  status        ProposalStatus   @default(PENDING)
  createdAt     DateTime         @default(now())
  kgNodeId      String?
  upvotes       Int              @default(0)
  downvotes     Int              @default(0)

  // relations
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  community   Community        @relation(fields: [communityId], references: [id], onDelete: Cascade)
}

model EdgeProposal {
  id            String           @id @default(uuid())
  userId        String
  communityId   String
  sourceId      String
  targetId      String
  relationType  String
  properties    Json?
  proposalType  ProposalType     @default(CREATE)
  status        ProposalStatus   @default(PENDING)
  createdAt     DateTime         @default(now())
  kgEdgeId      String?
  upvotes       Int              @default(0)
  downvotes     Int              @default(0)

  // relations
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  community     Community        @relation(fields: [communityId], references: [id], onDelete: Cascade)
}

model Vote {
  id           String        @id @default(uuid())
  userId       String
  targetId     String
  targetType   TargetType
  voteValue    Int
  timestamp    DateTime      @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([targetId, userId])
}

enum Role {
  ADMIN
  OWNER
  MEMBER
}

enum Action {
  PROPOSAL_APPROVED
  POST_LIKED
  VOTE_CAST
}

enum ProposalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProposalType {
  CREATE
  UPDATE
  DELETE
}

enum TargetType {
  NODE_PROPOSAL
  EDGE_PROPOSAL
  POST
  COMMENT
}